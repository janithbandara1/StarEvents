@{
    ViewData["Title"] = "Organizer Dashboard";
    Layout = null;
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - StarEvents</title>
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/StarEvents.styles.css" asp-append-version="true" />
</head>
<body>
<div class="d-flex">
    <!-- Side Navbar -->
    <nav class="flex-shrink-0 p-3 bg-dark text-light d-flex flex-column" style="position: fixed; left: 0; top: 0; width: 250px; height: 100vh;">
        <div class="flex-grow-1">
            <h4 class="mb-4">Organizer</h4>
            <ul class="nav nav-pills flex-column mb-auto">
                <li class="nav-item">
                    <a class="nav-link text-light active" id="menu-dashboard" href="#" onclick="showSection('dashboard')">
                        <i class="bi bi-house-door me-2"></i>Dashboard
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-light" id="menu-events" href="#" onclick="showSection('events')">
                        <i class="bi bi-calendar-event me-2"></i>Manage Events
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-light" id="menu-profile" href="@Url.Action("Profile", "Organizer")">
                        <i class="bi bi-person me-2"></i>My Profile
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-light" id="menu-sales-report" href="#" onclick="showSection('sales-report')">
                        <i class="bi bi-graph-up me-2"></i>Sales Report
                    </a>
                </li>
            </ul>
        </div>
        <!-- Logout Button at Bottom -->
        <div class="mt-auto pt-3 border-top">
            <a href="@Url.Action("Logout", "Users")" class="btn btn-danger w-100">
                <i class="bi bi-box-arrow-right me-2"></i>Logout
            </a>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="flex-grow-1 p-4" style="margin-left: 250px;">
        <!-- Dashboard Section -->
        <div id="section-dashboard">
            <h3><i class="bi bi-house-door me-2"></i>Dashboard Overview</h3>
            <div id="loading-dashboard" class="text-center" style="display: none;">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
            <div class="row" id="dashboard-stats">
                <!-- Stats will be loaded here -->
            </div>
        </div>

        <!-- Manage Events Section -->
        <div id="section-events" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3>Manage Events</h3>
                <button class="btn btn-primary" onclick="openEventDialog('add')">Add Event</button>
            </div>
            <div id="loading" class="text-center" style="display: none;">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>Title</th>
                        <th>Date</th>
                        <th>Location</th>
                        <th>Price</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="events-table-body">
                    <!-- Events will be loaded here via JS -->
                </tbody>
            </table>
        </div>

        <!-- Sales Report Section -->
        <div id="section-sales-report" style="display:none;">
            <h3><i class="bi bi-graph-up me-2"></i>Sales Report</h3>
            <div id="loading-sales-report" class="text-center" style="display: none;">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>Event</th>
                        <th>Tickets Sold</th>
                        <th>Total Sales</th>
                    </tr>
                </thead>
                <tbody id="sales-report-table-body">
                    <!-- Sales report data will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add/Edit Event Modal -->
<div class="modal fade" id="eventModal" tabindex="-1" aria-labelledby="eventModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="eventModalLabel">Add Event</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="eventForm">
                    @Html.AntiForgeryToken()
                    <input type="hidden" id="eventId" name="EventId" />
                    <div class="mb-3">
                        <label for="eventTitle" class="form-label">Title *</label>
                        <input type="text" class="form-control" id="eventTitle" name="Title" required />
                    </div>
                    <div class="mb-3">
                        <label for="eventDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="eventDescription" name="Description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="eventCategory" class="form-label">Category</label>
                        <input type="text" class="form-control" id="eventCategory" name="Category" />
                    </div>
                    <div class="mb-3">
                        <label for="eventLocation" class="form-label">Location *</label>
                        <input type="text" class="form-control" id="eventLocation" name="Location" required />
                    </div>
                    <div class="mb-3">
                        <label for="eventDate" class="form-label">Date *</label>
                        <input type="date" class="form-control" id="eventDate" name="EventDate" required />
                    </div>
                    <div class="mb-3">
                        <label for="eventPrice" class="form-label">Ticket Price *</label>
                        <input type="number" step="0.01" min="0" class="form-control" id="eventPrice" name="TicketPrice" required />
                    </div>
                    <div class="mb-3">
                        <label for="eventStatus" class="form-label">Status *</label>
                        <select class="form-select" id="eventStatus" name="Status" required>
                            <option value="Active">Active</option>
                            <option value="Inactive">Inactive</option>
                        </select>
                    </div>
                    <div class="d-flex justify-content-end">
                        <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary" id="saveEventBtn">
                            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                            Save Event
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Alert Messages -->
<div class="toast-container position-fixed top-0 end-0 p-3">
    <div id="alertToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <strong class="me-auto" id="toastTitle">Notification</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toastMessage">
            <!-- Message will be inserted here -->
        </div>
    </div>
</div>

<script src="~/lib/jquery/dist/jquery.min.js"></script>
<script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
<script src="~/js/site.js" asp-append-version="true"></script>
<script>
    let currentMode = 'add';
    let currentEventId = null;

    $(document).ready(function() {
        loadDashboardStats();
        
        const hash = window.location.hash.substring(1);
        if (hash && ['dashboard', 'events', 'sales-report'].includes(hash)) {
            showSection(hash);
        }
        
        // Form submission handler
        $('#eventForm').on('submit', function(e) {
            e.preventDefault();
            saveEvent();
        });
    });

    function showSection(section) {
        // Update active menu item
        $('.nav-link').removeClass('active');
        $('#menu-' + section).addClass('active');
        
        // Show/hide sections
        $('#section-dashboard').toggle(section === 'dashboard');
        $('#section-events').toggle(section === 'events');
        $('#section-sales-report').toggle(section === 'sales-report');
        
        if (section === 'events') {
            loadEvents();
        } else if (section === 'dashboard') {
            loadDashboardStats();
        } else if (section === 'sales-report') {
            loadSalesReport();
        }
    }

    function loadDashboardStats() {
        $('#loading-dashboard').show();
        $.get('@Url.Action("GetDashboardStats", "Organizer")')
            .done(function(response) {
                if (response.success) {
                    displayDashboardStats(response.data);
                } else {
                    showToast('Error', response.message, 'error');
                }
            })
            .fail(function() {
                showToast('Error', 'Failed to load dashboard stats. Please try again.', 'error');
            })
            .always(function() {
                $('#loading-dashboard').hide();
            });
    }

    function displayDashboardStats(data) {
        const statsContainer = $('#dashboard-stats');
        statsContainer.empty();

        const statsHtml = `
            <div class="col-md-3 mb-4">
                <div class="card text-center">
                    <div class="card-body">
                        <i class="bi bi-calendar-event display-4 text-primary"></i>
                        <h4 class="card-title">${data.totalEvents}</h4>
                        <p class="card-text">Total Events</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-4">
                <div class="card text-center">
                    <div class="card-body">
                        <i class="bi bi-check-circle display-4 text-success"></i>
                        <h4 class="card-title">${data.activeEvents}</h4>
                        <p class="card-text">Active Events</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-4">
                <div class="card text-center">
                    <div class="card-body">
                        <i class="bi bi-ticket-perforated display-4 text-warning"></i>
                        <h4 class="card-title">${data.totalTicketsSold}</h4>
                        <p class="card-text">Tickets Sold</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-4">
                <div class="card text-center">
                    <div class="card-body">
                        <i class="bi bi-cash display-4 text-info"></i>
                        <h4 class="card-title">$${parseFloat(data.totalRevenue).toFixed(2)}</h4>
                        <p class="card-text">Total Revenue</p>
                    </div>
                </div>
            </div>
        `;
        statsContainer.html(statsHtml);
    }

    function loadEvents() {
        $('#loading').show();
        $.get('@Url.Action("GetEvents", "Events")')
            .done(function(response) {
                if (response.success) {
                    displayEvents(response.data);
                } else {
                    showToast('Error', response.message, 'error');
                }
            })
            .fail(function() {
                showToast('Error', 'Failed to load events. Please try again.', 'error');
            })
            .always(function() {
                $('#loading').hide();
            });
    }

    function displayEvents(events) {
        const tbody = $('#events-table-body');
        tbody.empty();
        
        if (events.length === 0) {
            tbody.append('<tr><td colspan="6" class="text-center">No events found. Click "Add Event" to create your first event.</td></tr>');
            return;
        }
        
        events.forEach(function(event) {
            const row = `
                <tr>
                    <td>${event.title}</td>
                    <td>${event.eventDate}</td>
                    <td>${event.location}</td>
                    <td>$${event.ticketPrice.toFixed(2)}</td>
                    <td><span class="badge bg-${event.status === 'Active' ? 'success' : 'secondary'}">${event.status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="openEventDialog('edit', ${event.eventId})">Edit</button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteEvent(${event.eventId})">Delete</button>
                    </td>
                </tr>
            `;
            tbody.append(row);
        });
    }

    function openEventDialog(mode, eventId = null) {
        currentMode = mode;
        currentEventId = eventId;
        
        if (mode === 'add') {
            $('#eventModalLabel').text('Add Event');
            const token = $('input[name="__RequestVerificationToken"]').val();
            $('#eventForm')[0].reset();
            $('input[name="__RequestVerificationToken"]').val(token);
            $('#eventId').val('');
        } else if (mode === 'edit' && eventId) {
            $('#eventModalLabel').text('Edit Event');
            loadEventForEdit(eventId);
        }
        
        const modal = new bootstrap.Modal($('#eventModal')[0]);
        modal.show();
    }

    function loadEventForEdit(eventId) {
        $.get('@Url.Action("GetEvent", "Events")', { id: eventId })
            .done(function(response) {
                if (response.success) {
                    const event = response.data;
                    $('#eventId').val(event.eventId);
                    $('#eventTitle').val(event.title);
                    $('#eventDescription').val(event.description);
                    $('#eventCategory').val(event.category);
                    $('#eventLocation').val(event.location);
                    $('#eventDate').val(event.eventDate);
                    $('#eventPrice').val(event.ticketPrice);
                    $('#eventStatus').val(event.status);
                } else {
                    showToast('Error', response.message, 'error');
                }
            })
            .fail(function() {
                showToast('Error', 'Failed to load event details.', 'error');
            });
    }

    function saveEvent() {
        const submitBtn = $('#saveEventBtn');
        const spinner = submitBtn.find('.spinner-border');
        
        // Show loading state
        spinner.removeClass('d-none');
        submitBtn.prop('disabled', true);
        
        const formData = $('#eventForm').serialize();
        let url = '@Url.Action("Create", "Events")';
        
        if (currentMode === 'edit' && currentEventId) {
            url = '@Url.Action("Edit", "Events", new { id = "_ID_" })'.replace('_ID_', currentEventId);
        }
        
        $.ajax({
            url: url,
            type: 'POST',
            data: formData,
            success: function(response) {
                handleSaveResponse(response);
            },
            error: function(xhr, status, error) {
                console.error('Save error:', xhr.responseText);
                showToast('Error', 'Failed to save event. Please try again.', 'error');
            },
            complete: function() {
                spinner.addClass('d-none');
                submitBtn.prop('disabled', false);
            }
        });
    }

    function handleSaveResponse(response) {
        if (response.success) {
            showToast('Success', response.message, 'success');
            $('#eventModal').modal('hide');
            loadEvents(); // Reload the events table
        } else {
            showToast('Error', response.message, 'error');
        }
    }

    function deleteEvent(eventId) {
        if (confirm('Are you sure you want to delete this event?')) {
            const token = $('input[name="__RequestVerificationToken"]').val();
            
            $.ajax({
                url: '@Url.Action("Delete", "Events")',
                type: 'POST',
                data: { 
                    id: eventId,
                    __RequestVerificationToken: token
                },
                success: function(response) {
                    if (response.success) {
                        showToast('Success', response.message, 'success');
                        loadEvents();
                    } else {
                        showToast('Error', response.message, 'error');
                    }
                },
                error: function() {
                    showToast('Error', 'Failed to delete event. Please try again.', 'error');
                }
            });
        }
    }

    function showToast(title, message, type) {
        $('#toastTitle').text(title);
        $('#toastMessage').text(message);
        
        const toast = $('#alertToast');
        toast.removeClass('text-bg-success text-bg-danger text-bg-info');
        
        if (type === 'success') {
            toast.addClass('text-bg-success');
        } else if (type === 'error') {
            toast.addClass('text-bg-danger');
        } else {
            toast.addClass('text-bg-info');
        }
        
        const bsToast = new bootstrap.Toast(toast[0]);
        bsToast.show();
    }

    function loadSalesReport() {
        $('#loading-sales-report').show();
        $.get('@Url.Action("GetSalesReport", "Organizer")')
            .done(function(response) {
                if (response.success) {
                    displaySalesReport(response.data);
                } else {
                    showToast('Error', response.message, 'error');
                }
            })
            .fail(function() {
                showToast('Error', 'Failed to load sales report. Please try again.', 'error');
            })
            .always(function() {
                $('#loading-sales-report').hide();
            });
    }

    function displaySalesReport(data) {
        const tbody = $('#sales-report-table-body');
        tbody.empty();
        
        if (data.length === 0) {
            tbody.append('<tr><td colspan="3" class="text-center">No sales data available.</td></tr>');
            return;
        }
        
        data.forEach(function(item) {
            const row = `
                <tr>
                    <td>${item.eventTitle}</td>
                    <td>${item.ticketsSold}</td>
                    <td>$${parseFloat(item.totalSales).toFixed(2)}</td>
                </tr>
            `;
            tbody.append(row);
        });
    }
</script>
</body>
</html>